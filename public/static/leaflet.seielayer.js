!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t.L=t.L||{},t.L.SeieLayer=t.L.SeieLayer||{}))}(this,function(t){"use strict";function i(t,i){return new o(t,i)}function e(t){if(!(this instanceof e))return new e(t);this._canvas=t="string"==typeof t?document.getElementById(t):t,this._ctx=t.getContext("2d"),this._width=t.width,this._height=t.height,this._max=1,this._data=[]}function s(t,i){return new a(t,i)}var o=L.TileLayer.extend({version:1.4,defaultWmtsParams:{service:"WMTS",request:"GetTile",version:"1.0.0",layer:"",style:"",tilematrixSet:"",format:"image/png",transparent:!1},options:{tileSize:256,crs:null,uppercase:!1,noWrap:!0,reqDelayTime:50,bMutiUrl:!1,urls:null,origin:null,maxZoom:30,isRest:!1,errorTileUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyFpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpFMzBGRDdBREYwMkExMUU3OUQ5MUYzRTM2MjZENTI3NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpFMzBGRDdBRUYwMkExMUU3OUQ5MUYzRTM2MjZENTI3NyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkUzMEZEN0FCRjAyQTExRTc5RDkxRjNFMzYyNkQ1Mjc3IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkUzMEZEN0FDRjAyQTExRTc5RDkxRjNFMzYyNkQ1Mjc3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+mh/9JAAAABBJREFUeNpi+P//PwNAgAEACPwC/tuiTRYAAAAASUVORK5CYII="},initialize:function(t,i){this._url=t;var e=L.extend({},this.defaultWmtsParams),s=i.tileSize||this.options.tileSize;i.detectRetina&&L.Browser.retina?(e.width=2*s,e.height=2*s):(e.width=s,e.height=s);for(var o in i)this.options.hasOwnProperty(o)||"matrixIds"===o||(e[o]=i[o]);var a=i.token||"";a&&(e.token=a),this.wmtsParams=e,L.setOptions(this,i),this.urlIndex=-1,this.queryTileTimeOut=null,this.tileLoad=!0,this.bbox=null,this.tileLoadType="tile",this.queueNow=[]},onAdd:function(t){if(t){this._crs=this.options.crs||t.options.crs,this.matrixIds=this.options.matrixIds||this.getMatrix();var i=this._wmtsVersion>=1.3?"crs":"srs";this.wmtsParams[i]=t.options.crs.code,L.TileLayer.prototype.onAdd.call(this,t),this.tileLoadType="tile",this.queryTileTimeOut&&clearTimeout(this.queryTileTimeOut)}},formatRestUrl:function(t,i,e){return t.replace(i,e)},getTileUrl:function(t,i){var e=this._map;if(!e)return"";i=t.z||e.getZoom();var s=this.matrixIds[i].identifier,o=t.x,a=t.y,n="";this.options.isRest||(n=L.Util.template(this._url,{s:this._getSubdomain(t)}));var r=n||this._url;return this.options.bMutiUrl&&this.options.urls&&this.options.urls.length>0&&(this.urlIndex+=1,this.urlIndex>=this.options.urls.length&&(this.urlIndex=0),r=this.options.urls[this.urlIndex]),this.options.isRest?(n=this._url,n=this.formatRestUrl(n,"{tilematrix}",s),n=this.formatRestUrl(n,"{tilerow}",a),n=this.formatRestUrl(n,"{tilecol}",o)):r+L.Util.getParamString(this.wmtsParams,n,this.options.uppercase)+"&tilematrix="+s+"&tilerow="+a+"&tilecol="+o},setParams:function(t,i){return L.extend(this.wmtsParams,t),i||this.redraw(),this},getDefaultMatrix:function(){for(var t=new Array(22),i=0;i<22;i++)t[i]={identifier:String(i+1),topLeftCorner:new L.LatLng(90,-180)};for(var e=new Array(22),s=0;s<22;s++)e[s]={identifier:""+s,topLeftCorner:new L.LatLng(20037508.3428,-20037508.3428)};var o=this._crs&&this._crs.code;return"EPSG:4326"===o?t:"EPSG:3857"===o?e:void 0},getMatrix:function(){if(!this.options.origin||!this.options.origin.length||2!==this.options.origin.length)return this.getDefaultMatrix();for(var t=new Array(22),i=0;i<22;i++)t[i]={identifier:String(i),topLeftCorner:new L.LatLng(this.options.origin[1],this.options.origin[0])};return t},_isValidTile:function(t){var i=this._map.options.crs;if(!i.infinite){var e=this._globalTileRange;if(this.options.noWrap&&(t.x<0||t.x>e.max.x))return!1;if(!i.wrapLng&&(t.x<e.min.x||t.x>e.max.x)||!i.wrapLat&&(t.y<e.min.y||t.y>e.max.y))return!1}if(!this.options.bounds)return!0;var s=this._tileCoordsToBounds(t);return L.latLngBounds(this.options.bounds).overlaps(s)},_update:function(t){0===this.options.reqDelayTime?this.update1(t):(this.timeOut&&clearTimeout(this.timeOut),this.timeOut=setTimeout(L.bind(this.update1,this,t),this.options.reqDelayTime))},update1:function(t){var i=this,e=this._map;if(e){var s=e.getZoom();if(void 0===t&&(t=e.getCenter()),void 0!==this._tileZoom){if(s!==this._tileZoom)return void e.setView(t,this._tileZoom);var o=this._getTiledPixelBounds(t,s,this._tileZoom),a=this._pxBoundsToTileRange(o),n=a.getCenter(),r=[];for(var h in this._tiles)this._tiles[h].current=!1;if(Math.abs(s-this._tileZoom)>=1)return void this._setView(t,s);if(this.tileLoadType="none",this.bbox){this.addAroundTiles(t,this._tileZoom,r),this.addAroundTiles(t,this._tileZoom-1,r),this.addAroundTiles(t,this._tileZoom+1,r);for(var l=this.bbox.miny;l<=this.bbox.maxy;l++)for(var d=this.bbox.minx;d<=this.bbox.maxx;d++){var u=new L.Point(d,l);if(u.z=this._tileZoom,this._isValidTile(u)){var m=this._tiles[this._tileCoordsToKey(u)];m?m.current=!0:r.push(u)}}this.bbox=null,this.tileLoadType="bbox"}else for(var _=a.min.y;_<=a.max.y;_++)for(var p=a.min.x;p<=a.max.x;p++){var c=new L.Point(p,_);if(c.z=this._tileZoom,this._isValidTile(c)){var f=this._tiles[this._tileCoordsToKey(c)];f?f.current=!0:(r.push(c),this.tileLoadType="tile",this.queueNow=r)}}if("none"===this.tileLoadType&&(this.queryTileTimeOut&&clearTimeout(this.queryTileTimeOut),this.queryTileTimeOut=setTimeout(L.bind(function(){i.addAroundTiles(t,i._tileZoom,r),i.addAroundTiles(t,i._tileZoom-1,r),i.addAroundTiles(t,i._tileZoom+1,r),i.bbox=null,i.tileLoadType="bbox"},this),1e3)),r.sort(function(t,i){return t.distanceTo(n)-i.distanceTo(n)}),0!==r.length){this.queue=r,this._loading||(this._loading=!0,this.fire("loading"));for(var g=document.createDocumentFragment(),x=0;x<r.length;x++)r[x].z===this._tileZoom&&this._addTile(r[x],g);this._level.el.appendChild(g)}}}},_addTile:function(t,i){var e=this._getTilePos(t),s=this._tileCoordsToKey(t),o=this.createTile(this._wrapCoords(t),L.Util.bind(this._tileReady,this,t));this._initTile(o),this.createTile.length<2&&L.Util.requestAnimFrame(L.Util.bind(this._tileReady,this,t,null,o)),L.DomUtil.setPosition(o,e),this._tiles[s]={el:o,coords:t,current:!0},i.appendChild(o),this.fire("tileloadstart",{tile:o,coords:t})},_updateOpacity:function(){if(this._map&&!L.Browser.ielt9&&this._map._fadeAnimated){L.DomUtil.setOpacity(this._container,this.options.opacity);var t=!1;for(var i in this._tiles){var e=this._tiles[i];e.current&&e.loaded&&(L.DomUtil.setOpacity(e.el,1),t=!0,e.active=!0)}t&&!this._noPrune&&this._pruneTiles()}},_tileReady:function(t,i,e){if(this._map){i&&this.fire("tileerror",{error:i,tile:e,coords:t});var s=this._tileCoordsToKey(t);e=this._tiles[s],e&&(e.loaded=+new Date,this._map._fadeAnimated?(L.DomUtil.setOpacity(e.el,0),L.Util.cancelAnimFrame(this._fadeFrame),this._fadeFrame=L.Util.requestAnimFrame(this._updateOpacity,this)):(e.active=!0,this._pruneTiles()),i||(L.DomUtil.addClass(e.el,"leaflet-tile-loaded"),this.fire("tileload",{tile:e.el,coords:t})),this._noTilesToLoad()&&(this._loading=!1,this.fire("load"),"tile"===this.tileLoadType&&(this.tileLoadType="bbox",this.queryTileTimeOut&&clearTimeout(this.queryTileTimeOut),this.queryTileTimeOut=setTimeout(L.bind(this.addAroundTile,this),1e3)),L.Browser.ielt9||!this._map._fadeAnimated?L.Util.requestAnimFrame(this._pruneTiles,this):setTimeout(L.Util.bind(this._pruneTiles,this),250)))}},addAroundTile:function(){this.bbox={minx:null,miny:null,maxx:null,maxy:null,z:null};for(var t in this.queueNow)this.queueNow[t].x<=this.bbox.minx||!this.bbox.minx?this.bbox.minx=this.queueNow[t].x-1:(this.queueNow[t].x>=this.bbox.maxx||!this.bbox.maxx)&&(this.bbox.maxx=this.queueNow[t].x+1),this.queueNow[t].y<=this.bbox.miny||!this.bbox.miny?this.bbox.miny=this.queueNow[t].y-1:(this.queueNow[t].y>=this.bbox.maxy||!this.bbox.maxy)&&(this.bbox.maxy=this.queueNow[t].y+1),this.bbox.z=this.queueNow[t].z;this.queueNow=[],this._update()},addAroundTiles:function(t,i,e){if(!t||!i)return null;var s=this._getTiledPixelBounds(t,i,this._tileZoom),o=this._pxBoundsToTileRange(s);i===this._tileZoom&&(o.min.y--,o.min.x--,o.max.x++,o.max.y++);for(var a=o.min.y;a<=o.max.y;a++)for(var n=o.min.x;n<=o.max.x;n++){var r=new L.Point(n,a);if(r.z=i,this._isValidTile(r)){var h=this._tiles[this._tileCoordsToKey(r)];h?h.current=!0:e.push(r)}}return e},_getTilePos:function(t){var i=this._getPixelOffset();return t.scaleBy(this.getTileSize()).subtract(this._level.origin).subtract(i)},_getTiledPixelBounds:function(t,i){var e=this._map;if(e){var s=i||(e._animatingZoom?Math.max(e._animateToZoom,e.getZoom()):e.getZoom()),o=e.getZoomScale(s,i||this._tileZoom),a=e.project(t,i||this._tileZoom).floor(),n=e.getSize().divideBy(2*o);return new L.Bounds(a.subtract(n),a.add(n))}return null},_getPixelOffset:function(){var t=new L.Point(0,0),i=this.options.lngOffset,e=this.options.latOffset;if(i||e){var s=this._map,o=s.getCenter(),a=s.project(o,this._tileZoom),n=s.project(new L.LatLng(o.lat+e,o.lng+i),this._tileZoom);t.x=n.x-a.x,t.y=n.y-a.y}return t}});e.prototype={defaultRadius:25,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t,i){i=void 0===i?15:i;var e=this._circle=this._createCanvas(),s=e.getContext("2d"),o=this._r=t+i;return e.width=e.height=2*o,s.shadowOffsetX=s.shadowOffsetY=2*o,s.shadowBlur=i,s.shadowColor="black",s.beginPath(),s.arc(-o,-o,t,0,2*Math.PI,!0),s.closePath(),s.fill(),this},resize:function(){this._width=this._canvas.width,this._height=this._canvas.height},gradient:function(t){var i=this._createCanvas(),e=i.getContext("2d"),s=e.createLinearGradient(0,0,0,256);i.width=1,i.height=256;for(var o in t)s.addColorStop(+o,t[o]);return e.fillStyle=s,e.fillRect(0,0,1,256),this._grad=e.getImageData(0,0,1,256).data,this},draw:function(t){this._circle||this.radius(this.defaultRadius),this._grad||this.gradient(this.defaultGradient);var i=this._ctx;i.clearRect(0,0,this._width,this._height);for(var e,s=0,o=this._data.length;s<o;s++)e=this._data[s],i.globalAlpha=Math.max(e[2]/this._max,void 0===t?.05:t),i.drawImage(this._circle,e[0]-this._r,e[1]-this._r);var a=i.getImageData(0,0,this._width,this._height);return this._colorize(a.data,this._grad),i.putImageData(a,0,0),this},_colorize:function(t,i){for(var e,s=0,o=t.length;s<o;s+=4)(e=4*t[s+3])&&(t[s]=i[e],t[s+1]=i[e+1],t[s+2]=i[e+2])},_createCanvas:function(){return"undefined"!=typeof document?document.createElement("canvas"):new this._canvas.constructor}};var a=L.Layer.extend({options:{minOpacity:.05,radius:25,blur:15,max:1,level1:"blue",level2:"cyan",level3:"lime",level4:"yellow",level5:"red"},initialize:function(t,i){this._latlngs=t,L.setOptions(this,i)},setLatLngs:function(t){return this._latlngs=t,this.redraw()},addLatLng:function(t){return this._latlngs.push(t),this.redraw()},setOptions:function(t){return L.setOptions(this,t),this._heat&&this._updateOptions(),this.redraw()},redraw:function(){return this._heat&&!this._frame&&this._map&&!this._map._animating&&(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){this._map=t,this._canvas||this._initCanvas(),this.options.pane?this.getPane().appendChild(this._canvas):t._panes.overlayPane.appendChild(this._canvas),t.on("moveend",this._reset,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){this.options.pane?this.getPane().removeChild(this._canvas):t.getPanes().overlayPane.removeChild(this._canvas),t.off("moveend",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},_initCanvas:function(){var t=this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer leaflet-layer"),i=L.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","msTransformOrigin"]);t.style[i]="50% 50%";var s=this._map.getSize();t.width=s.x,t.height=s.y;var o=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(t,"leaflet-zoom-"+(o?"animated":"hide")),this._heat=e(t),this._updateOptions()},_updateOptions:function(){this._heat.radius(this.options.radius||this._heat.defaultRadius,this.options.blur);var t=this.options.level1,i=this.options.level2,e=this.options.level3,s=this.options.level4,o=this.options.level5,a={.4:t,.6:i,.7:e,.8:s,1:o};this._heat.gradient(a),this.options.max&&this._heat.max(this.options.max)},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t);var i=this._map.getSize();this._heat._width!==i.x&&(this._canvas.width=this._heat._width=i.x),this._heat._height!==i.y&&(this._canvas.height=this._heat._height=i.y),this._redraw()},_redraw:function(){if(this._map){var t,i,e,s,o,a,n,r,h,l=[],d=this._heat._r,u=this._map.getSize(),m=new L.Bounds(L.point([-d,-d]),u.add([d,d])),_=void 0===this.options.max?1:this.options.max,p=void 0===this.options.maxZoom?this._map.getMaxZoom():this.options.maxZoom,c=1/Math.pow(2,Math.max(0,Math.min(p-this._map.getZoom(),12))),f=d/2,g=[],x=this._map._getMapPanePos(),v=x.x%f,y=x.y%f;for(t=0,i=this._latlngs.length;t<i;t++)if(e=this._map.latLngToContainerPoint(this._latlngs[t]),m.contains(e)){o=Math.floor((e.x-v)/f)+2,a=Math.floor((e.y-y)/f)+2;var T=void 0!==this._latlngs[t].alt?this._latlngs[t].alt:void 0!==this._latlngs[t][2]?+this._latlngs[t][2]:1;h=T*c,g[a]=g[a]||[],s=g[a][o],s?(s[0]=(s[0]*s[2]+e.x*h)/(s[2]+h),s[1]=(s[1]*s[2]+e.y*h)/(s[2]+h),s[2]+=h):g[a][o]=[e.x,e.y,h]}for(t=0,i=g.length;t<i;t++)if(g[t])for(n=0,r=g[t].length;n<r;n++)(s=g[t][n])&&l.push([Math.round(s[0]),Math.round(s[1]),Math.min(s[2],_)]);this._heat.data(l).draw(this.options.minOpacity),this._frame=null}},_animateZoom:function(t){var i=this._map.getZoomScale(t.zoom),e=this._map._getCenterOffset(t.center)._multiplyBy(-i).subtract(this._map._getMapPanePos());L.DomUtil.setTransform?L.DomUtil.setTransform(this._canvas,e,i):this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(e)+" scale("+i+")"}});t.Wmts=o,t.wmts=i,t.Heatmap=a,t.heatmap=s,Object.defineProperty(t,"__esModule",{value:!0})});
